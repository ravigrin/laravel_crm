# Sentry Setup Instructions:
# 1. Database 'sentry' will be created automatically on first PostgreSQL startup.
#    If volume already exists, create manually:
#    docker-compose exec postgres_database psql -U ${DB_USERNAME} -c "CREATE DATABASE sentry;"
# 2. Generate SENTRY_SECRET_KEY and add to .env:
#    docker-compose run --rm sentry config generate-secret-key
# 3. Add SENTRY_SECRET_KEY and REDIS_PASSWORD to .env file
# 4. Initialize Sentry database (first time only):
#    docker-compose run --rm sentry upgrade --noinput
# 5. Create superuser (first time only):
#    docker-compose run --rm sentry createuser
# 6. Access Sentry at http://localhost:9000
# 7. Get DSN from Sentry project settings and add to .env:
#    SENTRY_LARAVEL_DSN=http://<public-key>@localhost:9000/<project-id>

services:

  nginx_webserver:
    build:
      context: .
      dockerfile: ./environment/nginx/Dockerfile
      args:
        - PHP_UPSTREAM_CONTAINER=php_fpm
        - PHP_UPSTREAM_PORT=9000
        - http_proxy
        - https_proxy
        - no_proxy
    restart: always
    volumes:
      - .:/var/www
      - ./environment/nginx/sites:/etc/nginx/sites-available
    ports:
      - "${APP_PORT}:80"
    depends_on:
      - php_fpm

  php_fpm:
    build:
      context: .
      dockerfile: ./environment/php/Dockerfile
    expose:
      - 9000
    environment:
      - APP_HOST=nginx_webserver
      - APP_NAME=${APP_NAME}
      - APP_ENV=${APP_ENV}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG}
      - APP_URL=${APP_URL}
      - APP_TIMEZONE=${APP_TIMEZONE}
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=postgres_database
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - TZ=${APP_TIMEZONE}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - LOG_CHANNEL=${LOG_CHANNEL}
      - QUEUE_CONNECTION=${QUEUE_CONNECTION}
      - CACHE_STORE=${CACHE_STORE}
      - SENTRY_LARAVEL_DSN=${SENTRY_LARAVEL_DSN}
      - SENTRY_DSN=${SENTRY_DSN}
    depends_on:

      - postgres_database

      - redis
    volumes:
      - .:/var/www


  postgres_database:
    build:
      context: .
      dockerfile: ./environment/postgres/Dockerfile
    environment:
      - POSTGRES_DATABASE=${DB_DATABASE}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - TZ=${APP_TIMEZONE}
    volumes:
      - pgdata:/var/opt/pgdata
      - ./environment/postgres/init-sentry-db.sh:/docker-entrypoint-initdb.d/init-sentry-db.sh
      # - ./environment/data/postgres:/var/lib/postgresql/data
    ports:
      - "${DB_PORT}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-${DB_USERNAME}}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    build:
      context: .
      dockerfile: ./environment/redis/Dockerfile
    ports:
      - "6379:6379"
    #expose:
     # - 6379

  sentry:
    image: getsentry/sentry:latest
    ports:
      - "9000:9000"
    environment:
      - SENTRY_SECRET_KEY=${SENTRY_SECRET_KEY:-changeme-in-production}
      - SENTRY_POSTGRES_HOST=postgres_database
      - SENTRY_POSTGRES_PORT=5432
      - SENTRY_DB_USER=${DB_USERNAME}
      - SENTRY_DB_PASSWORD=${DB_PASSWORD}
      - SENTRY_DB_NAME=sentry
      - SENTRY_REDIS_HOST=redis
      - SENTRY_REDIS_PORT=6379
      - SENTRY_REDIS_DB=0
      - SENTRY_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - SENTRY_URL_PREFIX=http://localhost:9000
      - SENTRY_SINGLE_ORGANIZATION=true
    depends_on:
      postgres_database:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - sentry-data:/var/lib/sentry/files
    command: run web
    restart: unless-stopped

  sentry-worker:
    image: getsentry/sentry:latest
    environment:
      - SENTRY_SECRET_KEY=${SENTRY_SECRET_KEY:-changeme-in-production}
      - SENTRY_POSTGRES_HOST=postgres_database
      - SENTRY_POSTGRES_PORT=5432
      - SENTRY_DB_USER=${DB_USERNAME}
      - SENTRY_DB_PASSWORD=${DB_PASSWORD}
      - SENTRY_DB_NAME=sentry
      - SENTRY_REDIS_HOST=redis
      - SENTRY_REDIS_PORT=6379
      - SENTRY_REDIS_DB=0
      - SENTRY_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - SENTRY_URL_PREFIX=http://localhost:9000
      - SENTRY_SINGLE_ORGANIZATION=true
    depends_on:
      postgres_database:
        condition: service_healthy
      redis:
        condition: service_started
      sentry:
        condition: service_started
    volumes:
      - sentry-data:/var/lib/sentry/files
    command: run worker
    restart: unless-stopped

  sentry-cron:
    image: getsentry/sentry:latest
    environment:
      - SENTRY_SECRET_KEY=${SENTRY_SECRET_KEY:-changeme-in-production}
      - SENTRY_POSTGRES_HOST=postgres_database
      - SENTRY_POSTGRES_PORT=5432
      - SENTRY_DB_USER=${DB_USERNAME}
      - SENTRY_DB_PASSWORD=${DB_PASSWORD}
      - SENTRY_DB_NAME=sentry
      - SENTRY_REDIS_HOST=redis
      - SENTRY_REDIS_PORT=6379
      - SENTRY_REDIS_DB=0
      - SENTRY_REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - SENTRY_URL_PREFIX=http://localhost:9000
      - SENTRY_SINGLE_ORGANIZATION=true
    depends_on:
      postgres_database:
        condition: service_healthy
      redis:
        condition: service_started
      sentry:
        condition: service_started
    volumes:
      - sentry-data:/var/lib/sentry/files
    command: run cron
    restart: unless-stopped

  horizon_worker:
    build:
      context: .
      dockerfile: ./environment/php/Dockerfile
    command: php artisan horizon
    environment:
      - APP_HOST=nginx_webserver
      - APP_NAME=${APP_NAME}
      - APP_ENV=${APP_ENV}
      - APP_KEY=${APP_KEY}
      - APP_DEBUG=${APP_DEBUG}
      - APP_URL=${APP_URL}
      - APP_TIMEZONE=${APP_TIMEZONE}
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=postgres_database
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - TZ=${APP_TIMEZONE}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - LOG_CHANNEL=${LOG_CHANNEL}
      - QUEUE_CONNECTION=redis
      - CACHE_STORE=redis
      - SENTRY_LARAVEL_DSN=${SENTRY_LARAVEL_DSN}
      - SENTRY_DSN=${SENTRY_DSN}
    depends_on:
      - postgres_database
      - redis
    volumes:
      - .:/var/www
    restart: unless-stopped




volumes:
  pgdata:
  sentry-data: