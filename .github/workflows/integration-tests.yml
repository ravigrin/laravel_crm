name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.2', '8.3']
        
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: mbstring, dom, fileinfo, mysql, redis, xdebug
        coverage: xdebug

    - name: Get composer cache directory
      id: composer-cache
      run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

    - name: Cache composer dependencies
      uses: actions/cache@v3
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: ${{ runner.os }}-composer-

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Create test database
      run: |
        mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS testing;"

    - name: Run database migrations
      run: php artisan migrate --env=testing

    - name: Run database seeders
      run: php artisan db:seed --env=testing

    - name: Create storage directories
      run: |
        mkdir -p storage/app/public
        mkdir -p storage/framework/cache
        mkdir -p storage/framework/sessions
        mkdir -p storage/framework/views
        mkdir -p storage/logs

    - name: Set permissions
      run: |
        chmod -R 775 storage
        chmod -R 775 bootstrap/cache

    - name: Run integration tests
      run: |
        php artisan test tests/Integration --verbose --coverage --min=80 --coverage-html=storage/app/coverage

    - name: Run unit tests
      run: |
        php artisan test tests/Unit --verbose

    - name: Run feature tests
      run: |
        php artisan test tests/Feature --verbose

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./storage/app/coverage/index.html
        flags: integration-tests
        name: integration-tests-coverage

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report-${{ matrix.php-version }}
        path: storage/app/coverage/
        retention-days: 7

    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('## Test Results')
          );
          
          const testResults = `
          ## Test Results
          
          ✅ **Integration Tests**: All tests passed
          ✅ **Unit Tests**: All tests passed  
          ✅ **Feature Tests**: All tests passed
          
          **PHP Version**: ${{ matrix.php-version }}
          **Coverage**: Generated and uploaded
          
          <details>
          <summary>Test Summary</summary>
          
          - Integration tests ensure all external API integrations work correctly
          - Unit tests verify individual components in isolation
          - Feature tests validate end-to-end functionality
          - FormRequest validation tests ensure data integrity
          - Job tests verify asynchronous processing
          
          </details>
          `;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: testResults
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: testResults
            });
          }

  test-performance:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, dom, fileinfo, mysql

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Copy environment file
      run: cp .env.example .env

    - name: Generate application key
      run: php artisan key:generate

    - name: Run performance tests
      run: |
        echo "Running performance tests..."
        time php artisan test tests/Integration --verbose
        echo "Performance test completed"

    - name: Check test execution time
      run: |
        start_time=$(date +%s)
        php artisan test tests/Integration
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        
        if [ $duration -gt 30 ]; then
          echo "⚠️  Warning: Tests took ${duration}s, which is longer than expected (30s)"
          exit 1
        else
          echo "✅ Tests completed in ${duration}s"
        fi
