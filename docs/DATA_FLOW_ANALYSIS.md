# Анализ проекта и базовые Data Flow

## Обзор проекта

Проект представляет собой **Laravel-приложение для управления лидами (leads)** с системой интеграций с внешними CRM и сервисами. Основная функциональность:

- Прием и обработка лидов через JSON:API
- Интеграция с множеством внешних сервисов (AmoCRM, Bitrix24, Email, Telegram, Webhooks и др.)
- Управление статусами лидов
- Экспорт данных
- Система уведомлений и очередей

## Архитектура системы

### Основные компоненты

1. **API Layer** - JSON:API контроллеры для работы с лидами
2. **Integration Layer** - Сервисы интеграций с внешними системами
3. **Queue System** - Асинхронная обработка через Laravel Queues
4. **Observer Pattern** - Обработка жизненного цикла лидов
5. **Service Layer** - Бизнес-логика (валидация, rate limiting, геолокация и т.д.)

---

## Базовые Data Flow

### 1. Создание лида (Lead Creation Flow)

```
┌─────────────────┐
│  External API   │
│  (JSON:API)     │
└────────┬────────┘
         │ POST /api/v1/leads
         ▼
┌─────────────────────────────────────┐
│  LeadController::store()             │
│  • Валидация JSON:API формата       │
│  • Маппинг camelCase → snake_case    │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  LeadLifecycleObserver::creating()   │
│  • Валидация userId, quizId          │
│  • Проверка верификации телефона     │
│  • Rate limiting (user, client)      │
│  • Обнаружение дубликатов            │
│  • Определение оплаты                │
│  • Проверка blocklist                │
│  • Геолокация по IP                  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Lead::create()                      │
│  • Сохранение в БД                   │
│  • Шифрование contacts               │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  LeadLifecycleObserver::created()    │
│  • Привязка телефона к лиду          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Notification Job (dispatch)         │
│  • Отложенная отправка (delay_sec)   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  JSON:API Response                   │
│  • Возврат созданного лида           │
└─────────────────────────────────────┘
```

**Ключевые сервисы:**
- `LeadValidationService` - валидация данных лида
- `PhoneVerificationService` - проверка верификации телефона
- `UserRateLimiter` / `ClientIdRateLimiter` - ограничение частоты запросов
- `DuplicateDetector` - обнаружение дубликатов
- `LeadPaymentService` - определение оплаты
- `LeadBlockService` - проверка блоклиста
- `GeoLocationService` - геолокация по IP

---

### 2. Отправка лида в интеграции (Integration Flow)

#### 2.1. Классический поток (Notification Job)

```
┌─────────────────────────────────────┐
│  Notification Job (handle)          │
│  • Получение лида по ID              │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  getCredentials()                    │
│  • EntityCredentials (по entity_id)   │
│  • ProjectCredentials (по project_id)│
│  • Фильтр: enabled = true            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Для каждой интеграции:              │
│  getIntegration(code, lead, creds)   │
│  • Создание через IoC container      │
│  • Вызов integration->send()          │
└─────────────────────────────────────┘
```

#### 2.2. Batch поток (SendLeadToMultipleIntegrationsJob)

```
┌─────────────────────────────────────┐
│  API: POST /integrations/send-batch  │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationController::sendLeadBatch│
│  • Валидация запроса                 │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  SendLeadToMultipleIntegrationsJob  │
│  • Создание batch из jobs            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Laravel Batch                       │
│  • allowFailures = true              │
│  • then() - успешное завершение      │
│  • catch() - критические ошибки      │
│  • finally() - всегда вызывается     │
└────────┬────────────────────────────┘
         │
         ├─────────────────┬─────────────────┬──────────────┐
         ▼                 ▼                 ▼              ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ Email        │  │ AmoCRM       │  │ Telegram     │  │ Bitrix24     │
│ Integration  │  │ Integration  │  │ Integration  │  │ Integration  │
│ Job          │  │ Job          │  │ Job          │  │ Job          │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │                 │
       ▼                 ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ integration- │  │ integration- │  │ integration- │  │ integration- │
│ email queue  │  │ amocrm queue │  │ telegram     │  │ bitrix24     │
│              │  │              │  │ queue        │  │ queue        │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
       │                 │                 │                 │
       ▼                 ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│  Queue Workers (параллельная обработка)                      │
└────────┬────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  BaseIntegrationJob::handle()        │
│  • Валидация credentials             │
│  • Создание Integration через Factory│
│  • Вызов integration->send()          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationManager                  │
│  • Управление интеграцией            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationChannelInterface::send() │
│  • Маппинг данных через FieldMapper  │
│  • Отправка во внешний сервис        │
│  • Возврат IntegrationResult        │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Batch Callbacks                     │
│  • then() - обновление статуса       │
│  • catch() - уведомления об ошибках  │
│  • finally() - финальное обновление  │
└─────────────────────────────────────┘
```

**Ключевые компоненты:**
- `IntegrationManager` - менеджер интеграций
- `IntegrationFactory` - фабрика создания интеграций
- `FieldMapperService` - маппинг данных лида в формат интеграции
- `IntegrationChannelInterface` - интерфейс всех интеграций
- `IntegrationResult` - типизированный результат операции

---

### 3. Обновление лида (Lead Update Flow)

```
┌─────────────────┐
│  External API   │
│  PATCH /leads   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  LeadController::update()            │
│  • JSON:API валидация                │
│  • Обновление через Store            │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Lead::update()                      │
│  • Обновление в БД                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  JSON:API Response                   │
└─────────────────────────────────────┘
```

**Примечание:** Обновление лида в интеграциях происходит через отдельный endpoint:
- `POST /api/integrations/update` - обновление лида в конкретной интеграции

---

### 4. Экспорт данных (Export Flow)

```
┌─────────────────┐
│  GET /export/    │
│  export          │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  ExportController::export()         │
│  • Валидация параметров             │
│  • Определение entity/project        │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  ExportToCsv Job (dispatch)          │
│  • Очередь: export_queue             │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  ExportToCsv::handle()               │
│  • Запрос данных из БД               │
│  • Генерация CSV файла               │
│  • Сохранение в Storage               │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  ExportFinished Event                │
│  • Уведомление о завершении          │
└─────────────────────────────────────┘
```

**Скачивание:**
- `GET /export/download` - скачивание готового файла

---

### 5. Получение лидов (Lead Retrieval Flow)

```
┌─────────────────┐
│  GET /v1/leads   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  LeadController::index()             │
│  • JSON:API фильтрация               │
│  • Пагинация                         │
│  • Сортировка                        │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Store::queryAll('leads')             │
│  • Построение запроса                │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Lead::query()                       │
│  • Применение фильтров               │
│  • Scope методы (forUser, forProject)│
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  JSON:API Response                   │
│  • Сериализация данных               │
└─────────────────────────────────────┘
```

**Специальные endpoints:**
- `GET /v1/leads/kanban` - данные для Kanban доски
- `GET /v1/leads/filter-counts` - счетчики для фильтров

---

### 6. Управление интеграциями (Integration Management Flow)

#### 6.1. Настройка credentials

```
┌─────────────────────────────────────┐
│  POST /integrations/{type}/credentials│
│  • AmoCRM, Bitrix24, Email и др.    │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  {Type}Controller::addCredentials()  │
│  • Валидация credentials             │
│  • Сохранение в БД                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  Credentials Model                   │
│  • Связь с Entity/Project            │
│  • enabled флаг                      │
└─────────────────────────────────────┘
```

#### 6.2. Тестирование подключения

```
┌─────────────────────────────────────┐
│  POST /integrations/test             │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationController::testConnection│
│  • Установка типа интеграции          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationManager::testConnection()│
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  IntegrationChannelInterface::       │
│  testConnection()                    │
│  • Проверка подключения              │
│  • Возврат IntegrationResult         │
└─────────────────────────────────────┘
```

---

## Модели данных

### Lead (Основная модель)

**Основные поля:**
- `id` - уникальный идентификатор
- `user_id`, `project_id`, `quiz_id` - владельцы
- `external_id`, `external_system`, `external_entity`, `external_entity_id` - внешняя идентификация
- `name`, `email`, `phone` - контактные данные
- `contacts` - зашифрованные персональные данные
- `data` - JSON данные лида (ответы на вопросы)
- `status` - статус лида (enum: New, AtWork, Success, Declined)
- `utm_*` - UTM метки
- `ip_address`, `city`, `country` - геолокация
- `viewed`, `paid`, `blocked`, `is_test` - флаги
- `integration_status` - статус интеграции
- `integration_data` - данные интеграций

**Особенности:**
- Шифрование поля `contacts` через `LeadContactEncryptionService`
- Soft deletes
- Кеширование запросов (через трейт `Cacheable`)

### Integration Credentials

**Структура:**
- `Credentials` - основная модель с credentials
- `EntityCredentials` - связь credentials с entity
- `ProjectCredentials` - связь credentials с project

**Использование:**
- Хранение настроек интеграций
- Привязка к entity/project уровням
- Флаг `enabled` для активации/деактивации

---

## Очереди (Queues)

### Назначение очередей

1. **integration-email** - Email интеграция
2. **integration-amocrm** - AmoCRM интеграция
3. **integration-telegram** - Telegram интеграция
4. **integration-bitrix24** - Bitrix24 интеграция
5. **integration-webhooks** - Webhooks интеграция
6. **notifications** - Системные уведомления
7. **export_queue** - Экспорт данных

### Преимущества разделения очередей

- **Масштабируемость** - отдельные воркеры для каждого типа
- **Изоляция** - ошибка в одной интеграции не блокирует другие
- **Приоритизация** - разные приоритеты для разных типов
- **Мониторинг** - детальная статистика по типам

---

## Интеграции

### Поддерживаемые интеграции

1. **Email** - отправка email уведомлений
2. **AmoCRM** - интеграция с AmoCRM
3. **Bitrix24** - интеграция с Bitrix24
4. **Telegram** - отправка в Telegram
5. **Webhooks** - отправка webhook запросов
6. **GetResponse** - email маркетинг
7. **SendPulse** - email маркетинг
8. **UniSender** - email маркетинг
9. **UonTravel** - CRM для туризма
10. **LpTracker** - трекинг лидов

### Архитектура интеграций

Все интеграции реализуют `IntegrationChannelInterface`:
- `send(Lead $lead, array $credentials): IntegrationResult`
- `update(Lead $lead, array $credentials): IntegrationResult`
- `testConnection(array $credentials): IntegrationResult`
- `validateCredentials(array $credentials): bool`

**Базовый класс:** `BaseIntegration` - общая логика для всех интеграций

**Маппинг данных:** `FieldMapperService` - конфигурируемый маппинг полей лида в формат интеграции

---

## Безопасность и валидация

### Уровни валидации

1. **API Level** - JSON:API валидация через FormRequest
2. **Observer Level** - валидация при создании лида
3. **Service Level** - бизнес-логика валидации

### Rate Limiting

- **User Rate Limiter** - ограничение по пользователю
- **Client ID Rate Limiter** - ограничение по клиенту (fingerprint)
- **Test Lead Limiter** - ограничение тестовых лидов

### Дополнительные проверки

- **Phone Verification** - проверка верификации телефона
- **Duplicate Detection** - обнаружение дубликатов
- **Blocklist Check** - проверка блоклиста
- **IP Filtering** - фильтрация по IP (middleware)

---

## Кеширование

### Уровни кеширования

1. **Query Cache** - кеширование запросов к БД (через трейт `Cacheable`)
2. **Redis Cache** - кеш для высоконагруженных операций
3. **Configuration Cache** - кеш конфигураций интеграций

---

## Мониторинг и логирование

### Логирование

- Все операции интеграций логируются
- Batch операции с детальной информацией
- Ошибки с полным trace

### События

- `ExportFinished` - завершение экспорта
- События жизненного цикла лидов через Observers

---

## Заключение

Система построена на принципах:

1. **Разделение ответственности** - четкое разделение слоев
2. **Асинхронность** - использование очередей для тяжелых операций
3. **Масштабируемость** - раздельные очереди и воркеры
4. **Расширяемость** - легко добавлять новые интеграции
5. **Надежность** - обработка ошибок, retry механизмы
6. **Типизация** - строгие типы и интерфейсы

Основной поток данных: **Lead Creation → Validation → Storage → Integration Dispatch → Queue Processing → External Services**



